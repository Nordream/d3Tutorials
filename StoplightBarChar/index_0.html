<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>

	<style>
		.bc-y-axis path,
		.bc-y-axis .tick line {
			fill: transparent;
		}

		.bc-x-axis path,
		.bc-x-axis line {
			fill: none;
			stroke:gray;
			stroke-width: 2px;
			opacity: 0.2;
			shape-rendering: crispEdges;
		}

		.bc-axis text {
			font-family: sans-serif;
			font-size: 12px;
			fill: #888;
		}

		.tick text {
			font-size: 12px;
		}
	</style>
</head>

<body>
	<div id="myChart"></div>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

	<script>

		var data =
			[
				{
					Name: "PRI-1",
					Risks:
						[
							{ Category: "Transaction", Weight: 13 },
							{ Category: "Counterparty", Weight: 15 },
							{ Category: "Object Provenance", Weight: 7 },
							{ Category: "Object Physicality", Weight: 9 }
						]
				},
				{
					Name: "PRI-2",
					Risks:
						[
							{ Category: "Transaction", Weight: 14 },
							{ Category: "Counterparty", Weight: 17 },
							{ Category: "Object Provenance", Weight: 4 },
							{ Category: "Object Physicality", Weight: 5 }
						]
				},
				{
					Name: "PRI-3",
					Risks:
						[
							{ Category: "Transaction", Weight: 9 },
							{ Category: "Counterparty", Weight: 6 },
							{ Category: "Object Provenance", Weight: 3 },
							{ Category: "Object Physicality", Weight: 13 }
						]
				}
			];

		var UNIT_LABEL_WIDTH = 110;
		var UNIT_LABEL_HEIGHT = 40;
		var GUTTER_WIDTH = 25;

		var margins = {
			left: UNIT_LABEL_WIDTH,
			bottom: UNIT_LABEL_HEIGHT,
			right: GUTTER_WIDTH
		};

		var sizes = {
			width: 700,
			height: 400
		};

		var width = sizes.width - margins.left - margins.right;
		var height = sizes.height - margins.bottom;

		var series = data.map((d) => d.Name);

		var dataset = data.map(function (d) {
			return d.Risks.map(function (o, i) {
				// Structure it so that your numeric axis (the stacked amount) is y
				return {
					y: o.Weight,
					x: o.Category
				};
			});
		});
		console.log(dataset);

		d3.layout.stack()(dataset);
		console.log(dataset);

		var dataset = dataset.map(function (group) {
			return group.map(function (d) {
				// Invert the x and y values, and y0 becomes x0
				return {
					x: d.y,
					y: d.x,
					x0: d.y0
				};
			});
		});

		var svg = d3.select('#myChart')
			.append('svg')
			.attr('width', width + margins.left + margins.right)
			.attr('height', height + margins.bottom)
			.append('g')
			.attr('transform', 'translate(' + margins.left + ', 0)');

		var units = dataset[0].map((d) => d.y);

		var yScale = d3.scale.ordinal()
			.domain(units)
			.rangeRoundBands([0, height], .1);

		var yAxis = d3.svg.axis()
			.scale(yScale)
			.orient('left');

		var xMax = d3.max(dataset, function (group) {
			var groupMax = d3.max(group, (d) => d.x + d.x0);
			return groupMax;
		});

		var xScale = d3.scale.linear()
			.domain([0, xMax])
			.range([0, width]);

		var xAxis = d3.svg.axis()
			.scale(xScale)
			.orient('bottom')
			.innerTickSize(-height)
			.outerTickSize(0)
			.tickPadding(10);

		var colors = function (i) {
			if (i == 0) return '#30A7D6';
			if (i == 1) return '#16557F';
			if (i == 2) return 'red';
		};

		var groups = svg.selectAll('g')
			.data(dataset)
			.enter()
			.append('g')
			.style('fill', (d, i) => colors(i));

		groups.selectAll('rect')
			.data(function (d) { return d; })
			.enter()
			.append('rect')
			.attr('x', (d) => xScale(d.x0))
			.attr('y', (d, i) => yScale(d.y))
			.attr('height', (d) => yScale.rangeBand())
			.attr('width', (d) => xScale(d.x));

		svg.append('g')
			.attr('class', 'bc-x-axis bc-axis')
			.attr('transform', 'translate(0,' + height + ')')
			.call(xAxis);

		svg.append('g')
			.attr('class', 'bc-y-axis bc-axis')
			.call(yAxis);

        //TODO: Legend
        //TODO: Tooltips

	</script>
</body>

</html>